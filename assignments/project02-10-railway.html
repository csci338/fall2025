<!doctype html>
<html lang="en">
    <head>
            <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/fall2025/assets/images/favicon.ico" type="image/x-icon">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>Cloud Deployment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="/fall2025/assets/main.css">
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163192686-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-163192686-1');
    </script>
    </head>
    <body class="two-column">
        <!-- banner -->
<header>
    <section>
        <h1 class="desktop"><a href="/fall2025/">CSCI 338: Fall 2025</a></h1>
        <h2 class="desktop">Software Engineering</h2>
        <a class="mobile" href="#">
            <i class="menu-toggle fas fa-bars"></i>
        </a>
        <h1 class="mobile">CSCI 338: Fall 2025</h1>
    </section>
    <img src="https://communication.unca.edu/wp-content/themes/tin/assets/logo.svg" />
</header>
        <nav>
    <ul>
        <li ><a href="/fall2025/syllabus/">Syllabus</a>
        </li>
        <li ><a
                href="/fall2025/">Schedule</a></li>
        <li class="active" ><a
                href="/fall2025/assignments/">Assignments</a></li>
        <li ><a
                href="/fall2025/resources/">Resources</a></li>
        <li ><a href="/fall2025/repos/">Repos</a>
        </li>
        <li><a href="https://drive.google.com/drive/folders/1iI-Iz85UpjGyuu9q_reuq4vT6hC4AEQq?usp=drive_link"
                target="_blank">Videos</a></li>
    </ul>
</nav>
        <main>
            <aside>
                
                
                <ol class="side-menu">
  <li><a href="#id_video-walkthroughs">Video Walkthroughs</a></li>
  <li><a href="#id_1-update-frontend-api-configuration">1. Update Frontend API Configuration</a></li>
  <li><a href="#id_2-create-a-production-dockerfile">2. Create a Production Dockerfile</a></li>
  <li><a href="#id_3-sign-up-for-railway">3. Sign up for Railway</a></li>
  <li><a href="#id_4-create-a-new-project">4. Create a new project</a></li>
  <li><a href="#id_5-create-a-postgresql-service">5. Create a PostgreSQL service</a></li>
  <li><a href="#id_6-create-a-web-service">6. Create a Web Service</a></li>
  <li><a href="#id_7-verify-deployment">7. Verify Deployment</a></li>
</ol>

            </aside>
            <article>
                


    <h1>
        <a href="../assignments/project02">Project 2</a> >
        Cloud Deployment
    </h1>
    
 
                <p>
    
    
    
</p>

<blockquote class="info">
  <h2 id="id_video-walkthroughs">Video Walkthroughs</h2>
  <ol>
    <li><a href="https://drive.google.com/file/d/1MmyV83eMFzVLnYDhGSQZn2ynRZYo1WYK/view?usp=drive_link" target="_blank">Introduction</a></li>
    <li><a href="https://drive.google.com/file/d/1_X_hPsT97gRtj3-GskBUrNDQI6yxiVRY/view?usp=drive_link" target="_blank">Code Modifications + Production Dockerfile</a></li>
    <li><a href="https://drive.google.com/file/d/17wGhOXOghkXdeTwlzqdi634zgL2vMoab/view?usp=drive_link" target="_blank">Railway Deployment</a></li>
    <li><a href="https://drive.google.com/file/d/1U00tHLq0D8uR08dpS24OEzJdre0H5zTR/view?usp=drive_link" target="_blank">CI / CD in Action</a></li>
  </ol>
</blockquote>

<h2 id="id_1-update-frontend-api-configuration">1. Update Frontend API Configuration</h2>

<p>Before creating the production Dockerfile, you need to update your <code class="language-plaintext highlighter-rouge">App.jsx</code> file to use an environment variable for the API URL. This allows your app to work in both development (localhost) and production (Railway).</p>

<p>Open <code class="language-plaintext highlighter-rouge">ui/src/App.jsx</code> and update the API URL configuration at the top of the file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Use environment variable for API URL, default to localhost for development</span>
<span class="c1">// In production (Railway), this will be empty string since frontend and backend are same origin</span>
<span class="c1">// Check if VITE_API_URL is explicitly set (even if empty string), otherwise use localhost</span>
<span class="kd">const</span> <span class="nx">API_URL</span> <span class="o">=</span>
    <span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VITE_API_URL</span> <span class="o">!==</span> <span class="kc">undefined</span>
        <span class="p">?</span> <span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VITE_API_URL</span>      <span class="c1">// address for production architecture</span>
        <span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:8000</span><span class="dl">'</span><span class="p">;</span>          <span class="c1">// address for local architecture</span>
</code></pre></div></div>

<p><strong>What this does:</strong></p>
<ul>
  <li>In <strong>development</strong>, <code class="language-plaintext highlighter-rouge">VITE_API_URL</code> is not set, so it defaults to <code class="language-plaintext highlighter-rouge">http://localhost:8000</code></li>
  <li>In <strong>production</strong>, the Dockerfile will set <code class="language-plaintext highlighter-rouge">VITE_API_URL</code> to an empty string (since frontend and backend are served from the same origin)</li>
  <li>When <code class="language-plaintext highlighter-rouge">VITE_API_URL</code> is empty, your API calls will use relative URLs (e.g., <code class="language-plaintext highlighter-rouge">/api/todos</code> instead of <code class="language-plaintext highlighter-rouge">http://localhost:8000/api/todos</code>)</li>
</ul>

<p><strong>Important:</strong> Make sure you’re using <code class="language-plaintext highlighter-rouge">API_URL</code> in all your <code class="language-plaintext highlighter-rouge">fetch()</code> calls throughout your React components. For example:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">fetch</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">API_URL</span><span class="p">}</span><span class="s2">/api/todos`</span><span class="p">)</span>
</code></pre></div></div>

<blockquote class="info">
  <h3 id="id_-before-you-move-on"><i class="fa-regular fa-circle-check"></i> Before you move on</h3>
  <p>Verify that:</p>
  <ul>
    <li>Your <code class="language-plaintext highlighter-rouge">App.jsx</code> (or wherever you define your API URL) uses the environment variable</li>
    <li>All your <code class="language-plaintext highlighter-rouge">fetch()</code> calls use the <code class="language-plaintext highlighter-rouge">API_URL</code> constant instead of hardcoded URLs</li>
  </ul>
</blockquote>

<h2 id="id_2-create-a-production-dockerfile">2. Create a Production Dockerfile</h2>

<p>Create <code class="language-plaintext highlighter-rouge">Dockerfile.prod</code> in the root directory:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Combined Production Dockerfile for Railway</span>
<span class="c"># Builds both frontend and backend, serves them together</span>

<span class="c"># Stage 1: Build Frontend</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:20-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">frontend-builder</span>

<span class="k">WORKDIR</span><span class="s"> /app/frontend</span>

<span class="c"># Accept VITE_API_URL as build argument (defaults to empty string for production)</span>
<span class="k">ARG</span><span class="s"> VITE_API_URL=""</span>
<span class="k">ENV</span><span class="s"> VITE_API_URL=$VITE_API_URL</span>

<span class="c"># Copy frontend package files</span>
<span class="k">COPY</span><span class="s"> ui/package.json ./</span>

<span class="c"># Install dependencies</span>
<span class="k">RUN </span>npm <span class="nb">install</span> <span class="nt">--production</span><span class="o">=</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    npm <span class="nb">install</span> @rollup/rollup-linux-x64-gnu <span class="nt">--save-optional</span> <span class="o">||</span> <span class="nb">true</span>

<span class="c"># Copy frontend source code</span>
<span class="k">COPY</span><span class="s"> ui/ ./</span>

<span class="c"># Build the React app</span>
<span class="k">RUN </span>npm run build

<span class="c"># Stage 2: Build Backend Dependencies</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">backend-builder</span>

<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="c"># Install Poetry</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-cache-dir</span> poetry

<span class="c"># Configure Poetry</span>
<span class="k">RUN </span>poetry config virtualenvs.create <span class="nb">false</span>

<span class="c"># Copy backend dependency files</span>
<span class="k">COPY</span><span class="s"> backend/pyproject.toml backend/poetry.lock* ./</span>

<span class="c"># Install dependencies (production only)</span>
<span class="k">RUN </span>poetry <span class="nb">install</span> <span class="nt">--no-interaction</span> <span class="nt">--no-ansi</span> <span class="nt">--only</span><span class="o">=</span>main <span class="nt">--no-root</span>

<span class="c"># Stage 3: Final Runtime Image</span>
<span class="k">FROM</span><span class="s"> python:3.11-slim</span>

<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="c"># Copy installed Python packages and binaries from builder</span>
<span class="k">COPY</span><span class="s"> --from=backend-builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages</span>
<span class="k">COPY</span><span class="s"> --from=backend-builder /usr/local/bin /usr/local/bin</span>

<span class="c"># Copy backend application code</span>
<span class="k">COPY</span><span class="s"> backend/ ./backend/</span>

<span class="c"># Copy built frontend from frontend-builder to /app/static</span>
<span class="k">COPY</span><span class="s"> --from=frontend-builder /app/frontend/dist ./static</span>

<span class="c"># Create non-root user for security</span>
<span class="k">RUN </span>useradd <span class="nt">-m</span> <span class="nt">-u</span> 1000 appuser <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">chown</span> <span class="nt">-R</span> appuser:appuser /app

<span class="k">USER</span><span class="s"> appuser</span>

<span class="c"># Expose port (Railway sets PORT automatically)</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>

<span class="c"># Use PORT environment variable if set, otherwise default to 8080</span>
<span class="k">ENV</span><span class="s"> PORT=8080</span>

<span class="c"># Change to backend directory and run server</span>
<span class="k">WORKDIR</span><span class="s"> /app/backend</span>
<span class="k">CMD</span><span class="s"> sh -c "uvicorn server:app --host 0.0.0.0 --port \${PORT:-8080}"</span>
</code></pre></div></div>

<p><strong>What this Dockerfile does:</strong></p>

<p>This Dockerfile uses a <strong>multi-stage build</strong> to create a single container that runs both your frontend and backend together. Here’s what happens in simple terms:</p>

<p><strong>Stage 1: Build the Frontend</strong></p>
<ul>
  <li>Starts with a Node.js image</li>
  <li>Installs all the frontend dependencies (React, Vite, etc.)</li>
  <li>Builds your React app into static files (HTML, CSS, JavaScript)</li>
  <li>The built files are saved in a <code class="language-plaintext highlighter-rouge">dist</code> folder</li>
</ul>

<p><strong>Stage 2: Prepare the Backend</strong></p>
<ul>
  <li>Starts with a Python image</li>
  <li>Installs Poetry and all your Python dependencies (FastAPI, SQLAlchemy, etc.)</li>
  <li>Gets everything ready to run your backend</li>
</ul>

<p><strong>Stage 3: Combine Everything</strong></p>
<ul>
  <li>Takes the built frontend files from Stage 1 and copies them into the final container</li>
  <li>Takes the backend code and Python packages from Stage 2 and copies them into the final container</li>
  <li>Creates a non-root user for security</li>
  <li>Sets up the container to run your FastAPI server, which will serve both:
    <ul>
      <li>Your backend API (at <code class="language-plaintext highlighter-rouge">/api/*</code> endpoints)</li>
      <li>Your frontend static files (at the root <code class="language-plaintext highlighter-rouge">/</code>)</li>
    </ul>
  </li>
</ul>

<p><strong>The result:</strong> One container that has everything your app needs to run in production. When Railway starts this container, it runs your FastAPI server, which handles both API requests and serves your React frontend.</p>

<p><strong>Important Notes:</strong></p>
<ul>
  <li>This is a multi-stage build that combines frontend and backend</li>
  <li>The frontend is built and served as static files by the backend</li>
  <li>Make sure your <code class="language-plaintext highlighter-rouge">server.py</code> has code to serve static files in production</li>
</ul>

<blockquote class="info">
  <h3 id="id_-before-you-move-on-1"><i class="fa-regular fa-circle-check"></i> Before you move on</h3>
  <p>Verify your production Dockerfile is in the root directory.</p>
</blockquote>

<h2 id="id_3-sign-up-for-railway">3. Sign up for Railway</h2>
<ul>
  <li>Go to https://railway.app</li>
  <li>Sign up with your GitHub account (recommended) or email</li>
  <li>Railway offers a free tier with $5/month credit</li>
</ul>

<h2 id="id_4-create-a-new-project">4. Create a new project</h2>
<ul>
  <li>Click “New Project” in the Railway dashboard</li>
  <li>Choose “Empty Project (the bottom option)</li>
</ul>

<p>Within your new project, you will add two new containers (called services)</p>

<h2 id="id_5-create-a-postgresql-service">5. Create a PostgreSQL service</h2>
<ul>
  <li>From within your project, click the “Add a service” button</li>
  <li>Select “Database” → “Add PostgreSQL”</li>
  <li>Railway will automatically create a PostgreSQL database</li>
</ul>

<p>Once the service has been built, click on the PostgreSQL service you just created. Then:</p>
<ul>
  <li>Go to the “Variables” tab</li>
  <li>Find the <code class="language-plaintext highlighter-rouge">DATABASE_URL</code> variable (Railway creates this automatically)</li>
  <li>Copy the connection string and paste it somewhere safe:
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  postgresql://postgres:password@hostname.railway.app:5432/railway
</code></pre></div>    </div>
  </li>
  <li>Modify the connection string to work with asynchronous connections:
    <ul>
      <li>Railway’s <code class="language-plaintext highlighter-rouge">DATABASE_URL</code> uses the format: <code class="language-plaintext highlighter-rouge">postgresql://...</code></li>
      <li>SQLAlchemy with asyncpg needs: <code class="language-plaintext highlighter-rouge">postgresql+asyncpg://...</code></li>
      <li>Replace <code class="language-plaintext highlighter-rouge">postgresql://</code> with <code class="language-plaintext highlighter-rouge">postgresql+asyncpg://</code> in your connection string</li>
    </ul>
  </li>
</ul>

<blockquote class="info">
  <h4 id="id_-before-you-move-on-2"><i class="fa-regular fa-circle-check"></i> Before you move on</h4>
  <p>Verify you have:</p>
  <ul>
    <li>A PostgreSQL database created in Railway</li>
    <li>The <code class="language-plaintext highlighter-rouge">DATABASE_URL</code> connection string copied</li>
    <li>The connection string modified to use <code class="language-plaintext highlighter-rouge">postgresql+asyncpg://</code></li>
  </ul>
</blockquote>

<h2 id="id_6-create-a-web-service">6. Create a Web Service</h2>
<p>Now that you’ve created your database container, you’re ready to create your web server, which will host your Backend and your Frontend on the same box. To do this, you will add a second service to your project:</p>

<ol>
  <li><strong>Add your application service:</strong>
    <ul>
      <li>In your Railway project dashboard, click “+ New”</li>
      <li>Select “GitHub Repo” → choose your repository</li>
      <li>You will also need to teach Railway how to deploy your web server by going to Settings → Deploy → Dockerfile Path: <code class="language-plaintext highlighter-rouge">Dockerfile.prod</code></li>
    </ul>
  </li>
  <li><strong>Set environment variables:</strong>
    <ul>
      <li>Go to the “Variables” tab in your application service</li>
      <li>Add the <code class="language-plaintext highlighter-rouge">DATABASE_URL</code> variable:
        <ul>
          <li>Click “+ New Variable”</li>
          <li>Name: <code class="language-plaintext highlighter-rouge">DATABASE_URL</code></li>
          <li>Value: Your modified connection string (with <code class="language-plaintext highlighter-rouge">postgresql+asyncpg://</code>)</li>
          <li>Click “Add”</li>
        </ul>
      </li>
      <li><strong>Important:</strong> Use the modified connection string (with <code class="language-plaintext highlighter-rouge">+asyncpg</code>) here</li>
    </ul>
  </li>
  <li><strong>Link the database:</strong>
    <ul>
      <li>Railway can automatically link services</li>
      <li>In your application service, go to the “Variables” tab</li>
      <li>You should see a “Reference Variable” option</li>
      <li>Reference the PostgreSQL service’s <code class="language-plaintext highlighter-rouge">DATABASE_URL</code></li>
      <li><strong>But remember:</strong> You still need to modify it to use <code class="language-plaintext highlighter-rouge">postgresql+asyncpg://</code></li>
    </ul>
  </li>
  <li><strong>Deploy:</strong>
    <ul>
      <li>Railway will automatically deploy when you push to your main branch</li>
      <li>Or click “Deploy” in the dashboard to trigger a manual deployment</li>
      <li>Watch the build logs to see the deployment progress</li>
    </ul>
  </li>
  <li><strong>Get your application URL:</strong>
    <ul>
      <li>Once deployed, Railway will provide a public URL</li>
      <li>Go to Settings → Networking → Generate Domain</li>
      <li>Your app will be available at: <code class="language-plaintext highlighter-rouge">https://your-app-name.up.railway.app</code></li>
    </ul>
  </li>
</ol>

<blockquote class="info">
  <h3 id="id_-before-you-move-on-3"><i class="fa-regular fa-circle-check"></i> Before you move on</h3>
  <p>Verify your application is:</p>
  <ul>
    <li>Deployed on Railway</li>
    <li>Connected to the PostgreSQL database</li>
    <li>Accessible via a public URL</li>
    <li>Test it by visiting your Railway URL</li>
  </ul>
</blockquote>

<h2 id="id_7-verify-deployment">7. Verify Deployment</h2>

<p>Test your deployed application:</p>

<ol>
  <li><strong>Visit your Railway URL:</strong>
    <ul>
      <li>Open <code class="language-plaintext highlighter-rouge">https://your-app-name.up.railway.app</code> in your browser</li>
      <li>Your application should load</li>
    </ul>
  </li>
  <li><strong>Test API endpoints:</strong>
    <ul>
      <li>Visit <code class="language-plaintext highlighter-rouge">https://your-app-name.up.railway.app/docs</code> to see the FastAPI documentation</li>
      <li>Test the <code class="language-plaintext highlighter-rouge">/todos</code> endpoint to verify database connectivity</li>
    </ul>
  </li>
  <li><strong>Test CRUD operations:</strong>
    <ul>
      <li>Create a new todo</li>
      <li>Read todos</li>
      <li>Update a todo</li>
      <li>Delete a todo</li>
      <li>Verify all operations work correctly</li>
    </ul>
  </li>
</ol>

<blockquote class="info">
  <h3 id="id_-before-you-move-on-4"><i class="fa-regular fa-circle-check"></i> Before you move on</h3>
  <p>Verify your deployed application:</p>
  <ul>
    <li>Loads correctly in the browser</li>
    <li>Has working API endpoints</li>
    <li>Successfully performs all CRUD operations</li>
    <li>Is accessible from any device with internet access</li>
  </ul>
</blockquote>

<hr />

<p><a href="project02">← Back to Project 2 Instructions</a></p>



            </article>  
        </main>
        <footer>
            <p>    
                Department of Computer Science, UNC Asheville
            </p>
        </footer>
        
        <script type="text/javascript" src="/fall2025/assets/js/main.js"></script>
<script type="text/javascript" src="/fall2025/assets/js/copy-code.js"></script>

<!-- <script>
    //little bit of a hack:
    const scrollLeft = () => {
        //console.log('scrollLeft');
        document.documentElement.scrollLeft = 0;
    };
    setTimeout(scrollLeft, 100);
</script> -->
        
        <script>
            window.h_max = "2";
        </script>
        
        <script type="text/javascript" src="/fall2025/assets/js/scrollspy.js"></script>
        <script type="text/javascript" src="/fall2025/assets/js/expandable.js"></script>
    </body>
</html>